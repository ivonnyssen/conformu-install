name: Test ConformU Install

on: [push, pull_request]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v6

      - name: Install ConformU
        uses: ./
        id: conformu

      - name: Test ConformU (Linux)
        if: runner.os == 'Linux'
        run: |
          conformu --version
          INSTALLED_VERSION=$(conformu --version | grep -oP 'Conform Universal \K[0-9]+\.[0-9]+\.[0-9]+')
          EXPECTED_VERSION="${{ steps.conformu.outputs.version }}"
          # Remove 'v' prefix if present
          EXPECTED_VERSION=${EXPECTED_VERSION#v}
          if [ "$INSTALLED_VERSION" = "$EXPECTED_VERSION" ]; then
            echo "✓ ConformU version test successful: $INSTALLED_VERSION"
          else
            echo "✗ Version mismatch: expected $EXPECTED_VERSION, got $INSTALLED_VERSION"
            exit 1
          fi
        shell: bash

      - name: Test ConformU (Windows)
        if: runner.os == 'Windows'
        run: |
          conformu --version
          $output = conformu --version
          $installedVersion = ($output | Select-String 'ConformU (\d+\.\d+\.\d+)').Matches[0].Groups[1].Value
          $expectedVersion = "${{ steps.conformu.outputs.version }}"
          if ($installedVersion -eq $expectedVersion) {
            Write-Host "✓ ConformU version test successful: $installedVersion"
          } else {
            Write-Host "✗ Version mismatch: expected $expectedVersion, got $installedVersion"
            exit 1
          }
        shell: powershell

      - name: Test ConformU (macOS)
        if: runner.os == 'macOS'
        run: |
          conformu --version
          $output = conformu --version
          $installedVersion = ($output | Select-String 'ConformU (\d+\.\d+\.\d+)').Matches[0].Groups[1].Value
          $expectedVersion = "${{ steps.conformu.outputs.version }}"
          if ($installedVersion -eq $expectedVersion) {
            Write-Host "✓ ConformU version test successful: $installedVersion"
          } else {
            Write-Host "✗ Version mismatch: expected $expectedVersion, got $installedVersion"
            exit 1
          }
        shell: pwsh
